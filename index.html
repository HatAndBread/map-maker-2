<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Map Maker</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
      /* Rad toolbox styles */
      #toolbox {
        position: absolute;
        top: 16px;
        left: 16px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 8px 8px;
        max-width: 170px;
        border-radius: 14px;
        background: linear-gradient(135deg, rgba(20,20,30,0.65), rgba(20,20,30,0.35));
        border: 1px solid rgba(255,255,255,0.2);
        box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 0 0 1px rgba(255,255,255,0.06);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: #e5e7eb;
        font-size: 11px;
      }
      #toolbox label {
        color: #e5e7eb;
        font-size: 10px;
        letter-spacing: 0.02em;
      }
      #toolbox span {
        color: #e5e7eb;
        font-weight: 500;
      }
      #toolbox select,
      #toolbox input[type="text"],
      #toolbox input[type="checkbox"] {
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.18);
        background: rgba(255,255,255,0.06);
        color: #e5e7eb;
        padding: 6px 8px;
        outline: none;
      }
      #toolbox select,
      #toolbox input[type="text"] { width: 100%; }
      #toolbox select { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      
      #toolbox button {
        appearance: none;
        border: 1px solid rgba(255,255,255,0.18);
        border-radius: 8px;
        padding: 6px 10px;
        color: #e5e7eb;
        font-weight: 600;
        letter-spacing: 0.01em;
        background: rgba(255,255,255,0.06);
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
        cursor: pointer;
        transition: background 150ms ease, border-color 150ms ease;
      }
      #toolbox button:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.24); }
      #toolbox button#redo { background: rgba(255,255,255,0.06); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04); }
      #toolbox .button-row { display: flex; gap: 6px; flex-direction: column; align-items: stretch !important; }
      #toolbox .button-row > * { flex: 1 1 auto; width: 100%; box-sizing: border-box; }
      #toolbox .button-row > button,
      #toolbox .button-row > label { flex: 1 1 auto; width: 100%; }
      #street-view-icon {
        position: absolute;
        bottom: 16px;
        right: 16px;
        z-index: 1000;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(20,20,30,0.65), rgba(20,20,30,0.35));
        border: 1px solid rgba(255,255,255,0.2);
        box-shadow: 0 10px 24px rgba(0,0,0,0.35), inset 0 0 0 1px rgba(255,255,255,0.06);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        cursor: grab;
      }
      #street-view-icon:hover { background: linear-gradient(135deg, rgba(20,20,30,0.7), rgba(20,20,30,0.42)); border-color: rgba(255,255,255,0.24); }
      #street-view-icon:active { cursor: grabbing; }
      #street-view-icon img {
        filter: drop-shadow(0 3px 10px rgba(0,0,0,0.45));
      }
      /* Floating actions: Street View + Undo/Redo */
      #floating-actions {
        position: absolute;
        bottom: calc(16px + env(safe-area-inset-bottom));
        right: calc(16px + env(safe-area-inset-right));
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      #floating-actions .buttons-undo-redo { display: flex; gap: 6px; }
      #floating-actions #street-view-icon { position: static; bottom: auto; right: auto; flex: 0 0 auto; }
      #floating-actions .buttons-undo-redo button { flex: 0 0 auto; }
      #floating-actions .buttons-undo-redo button {
        appearance: none;
        border: 1px solid rgba(255,255,255,0.28);
        border-radius: 8px;
        padding: 6px 10px;
        color: rgba(255,255,255,0.95);
        font-weight: 600;
        letter-spacing: 0.01em;
        background: linear-gradient(135deg, rgba(20,20,30,0.72), rgba(20,20,30,0.52));
        box-shadow: 0 6px 14px rgba(0,0,0,0.35), inset 0 0 0 1px rgba(255,255,255,0.06);
        cursor: pointer;
        transition: transform 120ms ease, background 140ms ease, border-color 140ms ease, box-shadow 140ms ease;
      }
      #floating-actions .buttons-undo-redo button:hover {
        background: linear-gradient(135deg, rgba(20,20,30,0.82), rgba(20,20,30,0.62));
        border-color: rgba(255,255,255,0.32);
        box-shadow: 0 9px 18px rgba(0,0,0,0.45), inset 0 0 0 1px rgba(255,255,255,0.07);
      }
      #floating-actions .buttons-undo-redo button:active { transform: none; }
      /* Elevate the Street View pill a bit more */
      #floating-actions #street-view-icon {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(20,20,30,0.7), rgba(20,20,30,0.4));
        border: 1px solid rgba(255,255,255,0.22);
        box-shadow: 0 10px 22px rgba(0,0,0,0.45), inset 0 0 0 1px rgba(255,255,255,0.06);
        transition: background 160ms ease, border-color 160ms ease, box-shadow 160ms ease;
      }
      #floating-actions #street-view-icon:hover {
        background: linear-gradient(135deg, rgba(20,20,30,0.78), rgba(20,20,30,0.46));
        border-color: rgba(255,255,255,0.28);
        box-shadow: 0 12px 26px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.07);
      }
      #floating-actions #street-view-icon:active {
        background: linear-gradient(135deg, rgba(20,20,30,0.74), rgba(20,20,30,0.44));
        border-color: rgba(255,255,255,0.26);
        box-shadow: 0 10px 22px rgba(0,0,0,0.45), inset 0 0 0 1px rgba(255,255,255,0.06);
      }
      /* Collapsible section */
      #toolbox-more { margin-top: 6px; }
      #toolbox-more > summary {
        list-style: none;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 20px;
        border-radius: 8px;
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.14);
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
        cursor: pointer;
      }
      #toolbox-more > summary::-webkit-details-marker { display: none; }
      #toolbox-more > summary svg {
        width: 12px;
        height: 12px;
        stroke: rgba(255,255,255,0.9);
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
        fill: none;
        transition: transform 200ms ease, stroke 200ms ease;
      }
      #toolbox-more[open] > summary { background: transparent; }
      #toolbox-more[open] > summary svg { transform: rotate(180deg); }
      /* Desktop: always open, hide chevron */
      @media (min-width: 481px) {
        #toolbox-more > summary { display: none !important; }
        #toolbox-more .toolbox-more-content {
          position: relative;
          margin-top: 8px;
          padding-top: 8px;
          border-top: 1px solid rgba(255,255,255,0.14);
          box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
        }
      }
      /* Mobile tweaks: keep top-left, shrink footprint */
      @media (max-width: 480px) {
        #toolbox {
          min-width: 0 !important;
          max-width: 68vw;
          padding: 6px 8px;
          gap: 4px;
          border-radius: 10px;
          font-size: 11px;
        }
        #toolbox label { font-size: 10px; }
        #toolbox button,
        #toolbox label[for="gpx-input"] { padding: 8px 10px; border-radius: 10px; }
        #toolbox-more { margin-top: 4px; }
        #toolbox-more > summary { width: 28px; height: 28px; }
        #toolbox-more > summary::before { width: 9px; height: 9px; border-right-width: 2px; border-bottom-width: 2px; }
        #toolbox-more[open] { max-height: 46vh; overflow: auto; }
        #toolbox .button-row { gap: 6px; }
      }
      /* Prettier file input */
      #gpx-input {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      #toolbox label[for="gpx-input"] {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        border-radius: 8px;
        padding: 6px 10px;
        color: #e5e7eb;
        font-weight: 600;
        letter-spacing: 0.01em;
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.18);
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
        cursor: pointer;
        transition: background 150ms ease, border-color 150ms ease;
      }
      #toolbox label[for="gpx-input"]:hover {
        background: rgba(255,255,255,0.1);
        border-color: rgba(255,255,255,0.24);
      }
      #toolbox label[for="gpx-input"].dropping {
        background: rgba(255,255,255,0.14);
        border-color: rgba(255,255,255,0.28);
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
      }
      .toolbox-more-content { margin-top: 10px; display: flex; flex-direction: column; gap: 6px; }
      /* Rad-as-heck custom checkbox */
      #straight-line {
        appearance: none;
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        border-radius: 4px;
        position: relative;
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.18);
        cursor: pointer;
        vertical-align: middle;
        transition: background 120ms ease, border-color 120ms ease;
        margin-left: 6px;
      }
      #straight-line:hover {
        background: rgba(255,255,255,0.08);
        border-color: rgba(255,255,255,0.22);
      }
      #straight-line:focus-visible {
        outline: 2px solid rgba(255,255,255,0.28);
        outline-offset: 2px;
      }
      #straight-line::after {
        content: "";
        position: absolute;
        top: 1px;
        left: 4px;
        width: 3px;
        height: 7px;
        border-right: 2px solid rgba(255,255,255,0.95);
        border-bottom: 2px solid rgba(255,255,255,0.95);
        transform: rotate(45deg);
        opacity: 0;
        transition: opacity 120ms ease;
      }
      #straight-line:checked {
        background: rgba(255,255,255,0.12);
        border-color: rgba(255,255,255,0.24);
      }
      #straight-line:checked::after { opacity: 1; }
      /* Mobile tweaks: keep top-left, shrink footprint; full-width subtle summary */
      @media (max-width: 480px) {
        #toolbox {
          min-width: 0 !important;
          max-width: 68vw;
          padding: 6px 8px;
          gap: 4px;
          border-radius: 10px;
          font-size: 11px;
        }
        #toolbox label { font-size: 10px; }
        #toolbox button,
        #toolbox label[for="gpx-input"] { padding: 8px 10px; border-radius: 10px; }
        #toolbox-more { margin-top: 4px; }
        #toolbox-more > summary { height: 16px; border-radius: 6px; }
        #toolbox-more > summary svg { width: 10px; height: 10px; }
        .toolbox-more-content { margin-top: 8px; gap: 8px; }
        #toolbox-more[open] { max-height: 46vh; overflow: auto; }
        #toolbox .button-row { gap: 6px; }
      }
      #toolbox button svg { width: 16px; height: 16px; stroke: #e5e7eb; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; fill: none; display: block; margin: 0 auto; }
    </style>
    <script type="module" src="./main.js"></script>
  </head>
  <body>
    <div id="app">
      <div id="toolbox" style="z-index: 1000;">
        <div>Elevation: <span id="elevation-value"></span></div>
        <div>Longitude: <span id="pointer-lng"></span></div>
        <div>Latitude: <span id="pointer-lat"></span></div>
        <div>Distance: <span id="distance-value"></span></div>
        <div>Distance 3D: <span id="distance-3d-value"></span></div>
        <details id="toolbox-more">
          <summary aria-label="More tools">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M6 9l6 6 6-6"/>
            </svg>
          </summary>
          <div class="toolbox-more-content">
            <div>
              <label for="straight-line">Straight Line</label>
              <input type="checkbox" id="straight-line" name="straight-line" />
            </div>
            <div>
              <label for="map-style">Map Style</label>
              <select id="map-style" name="map-style">
                <option value="mapbox://styles/mapbox/streets-v11">Streets</option>
                <option value="mapbox://styles/mapbox/outdoors-v11">Outdoors</option>
                <option value="osm:raster">OSM (Raster)</option>
                <option value="mapbox://styles/hatandbeard/clcn4yuyh000014nyxtgmilu7">Japan</option>
                <option value="mapbox://styles/hatandbeard/clco3a4v7001j15rqepdt67y1">Japan-En</option>
                <option value="mapbox://styles/mapbox/light-v11">Light</option>
                <option value="mapbox://styles/mapbox/dark-v11">Dark</option>
                <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
                <option value="mapbox://styles/mapbox/satellite-streets-v11">Satellite Streets</option>
                <option value="mapbox://styles/mapbox/navigation-preview-day-v4">Navigation Preview Day</option>
                <option value="https://basemaps.cartocdn.com/gl/positron-gl-style/style.json">Positron</option>
                <option value="https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json">Voyager</option>
                <option value="https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json">Dark Matter</option>
              </select>
            </div>
            <div>
              <label for="mapbox-profile">Profile</label>
              <select id="mapbox-profile" name="mapbox-profile">
                <option value="mapbox/walking">Walking</option>
                <option value="mapbox/cycling">Cycling</option>
                <option value="mapbox/driving">Driving</option>
              </select>
            </div>
            <div>
              <label for="measurement-system">Measurement System</label>
              <select id="measurement-system" name="measurement-system">
                <option value="METRIC">Metric</option>
                <option value="IMPERIAL">Imperial</option>
              </select>
            </div>
            <div class="button-row" style="align-items:center;">
              <input type="file" id="gpx-input" name="gpx-input" accept="application/gpx+xml" />
              <label for="gpx-input" id="gpx-label">Upload GPX</label>
            </div>
            <div style="display:flex; gap:8px;">
              <input name="file-name-input" type="text" id="file-name-input" placeholder="File Name"/>
              <button id="save-file">Save</button>
            </div>
          </div>
        </details>
      </div>
      <div id="floating-actions">
        <div class="buttons-undo-redo">
          <button id="undo">Undo</button>
          <button id="redo">Redo</button>
        </div>
        <div id="street-view-icon" draggable="true" aria-label="Street View" title="Drag onto the map for Street View">
          <img src="./street-view.svg" alt="Street View" width="24" height="24" />
        </div>
      </div>
      <iframe id="streetview-preview" style="position: fixed; bottom: 0; left: 0; width: 200px; height: 200px; z-index: 1000; background-color: white; display: none; border: none; border-radius: 10px;"></iframe>
      <div id="map"></div>
    </div>
    <script>
      (function(){
        const input = document.getElementById('gpx-input');
        const label = document.getElementById('gpx-label');
        if (!input || !label) return;
        const prevent = (e) => { e.preventDefault(); e.stopPropagation(); };
        ['dragenter','dragover','dragleave','drop'].forEach(ev => {
          label.addEventListener(ev, prevent);
        });
        ['dragenter','dragover'].forEach(ev => {
          label.addEventListener(ev, () => label.classList.add('dropping'));
        });
        ['dragleave','drop'].forEach(ev => {
          label.addEventListener(ev, () => label.classList.remove('dropping'));
        });
        label.addEventListener('drop', (e) => {
          const dt = e.dataTransfer;
          if (!dt || !dt.files || !dt.files.length) return;
          input.files = dt.files; // triggers change listeners already set up in JS
          input.dispatchEvent(new Event('change', { bubbles: true }));
        });
      })();

      (function(){
        const details = document.getElementById('toolbox-more');
        if (!details) return;
        const mq = window.matchMedia('(max-width: 480px)');
        const apply = () => { details.open = !mq.matches; };
        apply();
        if (mq.addEventListener) {
          mq.addEventListener('change', apply);
        } else if (mq.addListener) {
          mq.addListener(apply);
        }
      })();
    </script>
  </body>
</html>
